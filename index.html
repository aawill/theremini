<!DOCTYPE html>
<html>
<head>
<title>Theremini</title>
<meta charset="utf-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
</head>
<body>
<style>
.oscMenu {
    position: relative;
    text-align: center;
}
.filterMenu {
    position: relative;
    text-align: center;
}
.dropdown-toggle {
    margin-bottom: 10px;
}

.slider {
    -webkit-appearance: slider-vertical;
    width: 8px;
    height: 175px;
    padding: 0 5px;
}

.slider::-webkit-slider-thumb {
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    background: #4CAF50;
    cursor: pointer;
}

</style>
<script>
$(document).ready(function() {
    initializeAudio(220);
    $("#freqLabel1").html(Math.trunc(osc1Freq));
    $("#freqLabel2").html(Math.trunc(osc2Freq));
    $("#freqLabel3").html(Math.trunc(osc3Freq));
    $("#filterLabel1").html(Math.trunc(filter1Freq));
    $("#freqSlider1").val(logposition(osc1Freq));
    $("#freqSlider2").val(logposition(osc2Freq));
    $("#freqSlider3").val(logposition(osc3Freq));
    $("#filterSlider1").val(logposition(filter1Freq));
    $("#soundBut").click(function() {
        audioCtx.resume();
        if ($(this).hasClass("active")) {
            stopOscs();
            $(this).removeClass("active");
        }
        else {
            playOscs();
            $(this).addClass("active");
        }
    });
    $(".osc1Shape").click(function() {
        osc1Shape = this.name;
        if (typeof osc1 !== "undefined") {
            osc1.type = osc1Shape;
        }
        $("#shape1").text($(this).text());
    });
    $(".osc2Shape").click(function() {
        osc2Shape = this.name;
        if (typeof osc2 !== "undefined") {
            osc2.type = osc2Shape;
        }
        $("#shape2").text($(this).text());
    });
    $(".osc3Shape").click(function() {
        osc3Shape = this.name;
        if (typeof osc3 !== "undefined") {
            osc3.type = osc3Shape;
        }
        $("#shape3").text($(this).text());
    });
    $(".filter1Type").click(function() {
        filter1.type = this.name;
        $("#type1").text($(this).text());
    })
    $("#freqSlider1").on("input", function() {
        $("#freqLabel1").html(Math.trunc(logslider(this.value)));
        osc1Freq = logslider(this.value);
        if (typeof osc1 !== "undefined") {
            osc1.frequency.value = osc1Freq;
        }
    });
    $("#freqSlider2").on("input", function() {
        $("#freqLabel2").html(Math.trunc(logslider(this.value)));
        osc2Freq = logslider(this.value);
        if (typeof osc2 !== "undefined") {
            osc2.frequency.value = osc2Freq;
        }
    });
    $("#freqSlider3").on("input", function() {
        $("#freqLabel3").html(Math.trunc(logslider(this.value)));
        osc3Freq = logslider(this.value);
        if (typeof osc3 !== "undefined") {
            osc3.frequency.value = osc3Freq;
        }
    });
    $("#filterSlider1").on("input", function() {
        $("#filterLabel1").html(Math.trunc(logslider(this.value)));
        filter1.frequency.value = logslider(this.value);
    })
});  

function logslider(position) {
    var minp = 0;
    var maxp = 100;
    var minv = Math.log(20);
    var maxv = Math.log(20000);

    var scale = (maxv-minv) / (maxp-minp);
    return Math.exp(minv + scale*(position-minp));
}    

function logposition(value) {
    var minp = 0;
    var maxp = 100;
    var minv = Math.log(20);
    var maxv = Math.log(20000);

    var scale = (maxv-minv) / (maxp-minp);
    return (Math.log(value)-minv) / scale + minp;
}
    
function initializeAudio(freqIn) {
    var freq = freqIn;
    audioCtx = new (window.AudioContext || window.webkitAudioContext);
    volume = audioCtx.createGain();
    volume.connect(audioCtx.destination);
    
    filter1Freq = 20000;
    filter1 = audioCtx.createBiquadFilter();
    filter1.connect(volume);
    filter1.type = "lowpass";
    filter1.frequency.value = filter1Freq;
    
    osc1Freq = freq;
    osc2Freq = freq * Math.pow(Math.pow(2, (1/12)), 7);
    osc3Freq = freq * 2;
    osc1Shape = "sine", osc2Shape = "sine", osc3Shape = "sine";
    
    var osc1 = audioCtx.createOscillator();
    osc1.frequency.value = osc1Freq;
    osc1.type = osc1Shape;
    var osc2 = audioCtx.createOscillator();
    osc2.frequency.value = osc2Freq;
    osc2.type = osc2Shape;
    var osc3 = audioCtx.createOscillator();
    osc3.frequency.value = osc3Freq;
    osc3.type = osc3Shape;
}
  
function playOscs() {
    osc1 = audioCtx.createOscillator();
    osc1.frequency.value = osc1Freq;
    osc1.type = osc1Shape;
    osc1.connect(filter1);
    osc2 = audioCtx.createOscillator();
    osc2.frequency.value = osc2Freq;
    osc2.type = osc2Shape;
    osc2.connect(filter1);
    osc3 = audioCtx.createOscillator();
    osc3.frequency.value = osc3Freq;
    osc3.type = osc3Shape;
    osc3.connect(filter1);
    osc1.start();
    osc2.start();
    osc3.start();
}
    
function stopOscs() {
    osc1.stop();
    osc2.stop();
    osc3.stop();
}    

</script>
<br/>
<h3 class="text-center">Simple Synthesizer</h3>
<div class="row justify-content-center">
<button id="soundBut" class="btn btn-success">Toggle sound</button>
</div>
<br/>
<br/>
<div class="row justify-content-center">
<div class="dropdown oscMenu col-sm-3 col-md-3 col-lg-2">
  <h5 class="text-center">Oscillator 1</h5>
  <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
  <span id="shape1">Wave shape</span>
  </button>
  <div class="dropdown-menu">
    <button class="dropdown-item osc1Shape" type="button" name="sine">Sine</button>
    <button class="dropdown-item osc1Shape" type="button" name="square">Square</button>
    <button class="dropdown-item osc1Shape" type="button" name="sawtooth">Sawtooth</button>
  </div>
  <div>
  <input type="range" id ="freqSlider1" class="slider freqSlider" min="0" max="100" orient="vertical"/>
  <p>Frequency: <span id="freqLabel1"></span></p>
  </div>
  <hr style='border: none; clear: both'>
</div>
<div class="dropdown oscMenu col-sm-3 col-md-3 col-lg-2">
  <h5 class="text-center">Oscillator 2</h5>
  <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
  <span id="shape2">Wave shape</span>
  </button>
  <div class="dropdown-menu">
    <button class="dropdown-item osc2Shape" type="button" name="sine">Sine</button>
    <button class="dropdown-item osc2Shape" type="button" name="square">Square</button>
    <button class="dropdown-item osc2Shape" type="button" name="sawtooth">Sawtooth</button>
  </div>
  <div>
  <input type="range" id ="freqSlider2" class="slider vertical freqSlider" min="0" max="100" orient="vertical"/>
  <p>Frequency: <span id="freqLabel2"></span></p>
  </div>
</div>
<div class="dropdown oscMenu col-sm-3 col-md-3 col-lg-2">
  <h5 class="text-center">Oscillator 3</h5>
  <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
  <span id="shape3">Wave shape</span>
  </button>
  <div class="dropdown-menu">
    <button class="dropdown-item osc3Shape" type="button" name="sine">Sine</button>
    <button class="dropdown-item osc3Shape" type="button" name="square">Square</button>
    <button class="dropdown-item osc3Shape" type="button" name="sawtooth">Sawtooth</button>
  </div>
  <div>
  <input type="range" id ="freqSlider3" class="slider vertical freqSlider" min="0" max="100" orient="vertical"/>
  <p>Frequency: <span id="freqLabel3"></span></p>
  </div>
</div>
</div>
<div class="row justify-content-center">
  <div class="dropdown filterMenu col-sm-3 col-md-3 col-lg-2">
    <h5 class="text-center">Filter</h5>
    <button class="btn btn-info dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <span id="type1">Filter type</span>
    </button>
    <div class="dropdown-menu">
    <button class="dropdown-item filter1Type" type="button" name="lowpass">Low pass</button>
    <button class="dropdown-item filter1Type" type="button" name="highpass">High pass</button>
    <button class="dropdown-item filter1Type" type="button" name="bandpass">Band pass</button>
  </div>
  <div>
  <input type="range" id ="filterSlider1" class="slider vertical filterSlider" min="0" max="100" orient="vertical"/>
  <p>Cutoff frequnecy: <span id="filterLabel1"></span></p>
  </div>       
  </div>
</div>
</body>
</html>
